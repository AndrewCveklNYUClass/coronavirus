<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coronavirus/COVID-19 Cases</title>
    <script src="bower_components/axios/dist/axios.min.js"></script>
    <script src="bower_components/csvtojson/browser/csvtojson.min.js"></script>
    <script src="bower_components/vue/dist/vue.min.js"></script>
    <script src="bower_components/chart.js/dist/Chart.bundle.min.js"></script>
</head>
<body>
<div style="float: right;">
    <canvas id="graph_canvas" width="640" height="480"></canvas>
</div>
<div id="app">
    <div style="float: right;">
        <input id="cases_checkbox" type="checkbox" v-model="showCases"/>
        <label for="cases_checkbox">Cases</label>
        <input id="deaths_checkbox" type="checkbox" v-model="showDeaths"/>
        <label for="deaths_checkbox">Deaths</label>

        <input type="radio" id="joint_axis_radio" name="axes" v-model="axes" value="joint"/>
        <label for="joint_axis_radio">Joint Axis</label>
        <input type="radio" id="separate_axes_radio" name="axes" v-model="axes" value="separate" :disabled="!canSeparateAxes"/>
        <label for="separate_axes_radio">Separate Axes</label>

    </div>
    <input id="select_all_checkbox" type="checkbox" v-model="selectAll" :indeterminate.prop="partialSelection"/>
    <label for="select_all_checkbox">Select All</label>
    <br/>
    <span v-for="country in countries">
        <input type="checkbox" v-bind:id="country" v-bind:value="country" v-model="checkedCountries"/>
        <label v-bind:for="country">{{country}}</label>
        <br/>
    </span>
    <span>Checked countries ({{selectionLength}}): {{checkedCountries}}</span>
    <p>{{timeSeries}}</p>
    <span style="clear: both;"></span>
</div>
<script type="application/javascript">

    (async () => {
        const confirmedResponse = await axios({
            method: 'get',
            url: 'docs/data/covid_confirmed.csv',
        });
        const deadResponse = await axios({
            method: 'get',
            url: 'docs/data/covid_dead.csv',
        });
        const confirmedCases = await csv({output: 'json'}).fromString(confirmedResponse.data);
        const deadCases = await csv({output: 'json'}).fromString(deadResponse.data);

        // parse the data into what we need
        const countries = new Set();
        const states = new Set();
        const countriesByState = {}; // look up a state's country
        const countryStates = {}; // enumerate up all states in a country
        for (const location of confirmedCases) {
            const currentCountry = location['Country/Region'];
            const currentState = location['Province/State'];
            countries.add(currentCountry);
            if (currentState.length < 1) {
                continue;
            }
            states.add(currentState);
            countriesByState[currentState] = currentCountry;
            countryStates[currentCountry] = countryStates[currentCountry] || new Set();
            countryStates[currentCountry].add(currentState);
        }

        const doubleAxes = [
            {
                id: 'cases-axis',
                ticks: {
                    beginAtZero: true
                },
                labelString: 'Cases',
                color: 'orange'
            },
            {
                id: 'deaths-axis',
                ticks: {
                    beginAtZero: true
                },
                position: 'right',
                labelString: 'Deaths',
                color: 'red'
            }
        ];
        const singleAxis = [{
            ticks: {
                beginAtZero: true
            },
        }];


        // initialize data set context
        const ctx = document.getElementById('graph_canvas').getContext('2d');
        const chartConfig = {
            type: 'line',
            data: {
                labels: [],
                datasets: [
                    {
                        label: 'Case Count',
                        data: [],
                        backgroundColor: 'rgb(0, 0, 0)',
                        borderColor: 'rgba(240, 200, 50, 1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    },
                    {
                        label: 'Deaths',
                        data: [],
                        backgroundColor: 'rgb(0, 0, 0)',
                        borderColor: 'rgba(220, 50, 50, 1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    }
                ],
            },
            options: {
                scales: {
                    yAxes: singleAxis
                }
            }
        };
        const graph = new Chart(ctx, chartConfig);


        const app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue!',
                countries,
                cases: confirmedCases,
                deaths: deadCases,
                checkedCountries: [],
                selectAll: false,
                partialSelection: false,
                showCases: true,
                showDeaths: true,
                axes: 'joint'
            },
            watch: {
                selectAll: function (newValue) {
                    if (newValue) {
                        this.checkedCountries = Array.from(this.countries);
                        this.partialSelection = false;
                    } else {
                        this.checkedCountries = [];
                    }
                },
                checkedCountries: function (newValue) {
                    const selectedCountryCount = newValue.length;
                    const totalCountryCount = this.countries.size;
                    if (selectedCountryCount === 0) {
                        this.selectAll = false;
                        this.partialSelection = false;
                    } else if (selectedCountryCount === totalCountryCount) {
                        this.selectAll = true;
                        this.partialSelection = false;
                    } else {
                        this.partialSelection = true;
                    }
                },
                axes: function (newValue) {
                    if (newValue === 'joint') {
                        // remove second y axis
                        chartConfig.options.scales.yAxes = singleAxis;
                        delete chartConfig.data.datasets[0].yAxisID;
                        delete chartConfig.data.datasets[1].yAxisID;
                    } else {
                        chartConfig.options.scales.yAxes = doubleAxes;
                        chartConfig.data.datasets[0].yAxisID = doubleAxes[0].id;
                        chartConfig.data.datasets[1].yAxisID = doubleAxes[1].id;
                    }
                    graph.update();
                },
                canSeparateAxes: function(newValue) {
                    if(!newValue){
                        this.axes = 'joint';
                    }
                }
            },
            computed: {
                selectionLength: function () {
                    return this.checkedCountries.length;
                },
                canSeparateAxes: function () {
                    return this.showCases && this.showDeaths;
                },
                timeSeries: function () {
                    const dates = {};
                    const dateLabels = new Set();

                    const confirmedYValues = [];
                    const deadYValues = [];
                    {
                        for (const currentLocation of this.cases) {
                            const currentCountry = currentLocation['Country/Region'];
                            const currentState = currentLocation['Province/State'];
                            if (!this.checkedCountries.includes(currentCountry)) {
                                continue;
                            }
                            let dateIndex = 0;
                            for (const [key, value] of Object.entries(currentLocation)) {
                                if (['Province/State', 'Country/Region', 'Lat', 'Long'].includes(key)) {
                                    continue;
                                }
                                const currentDate = key;
                                dateLabels.add(currentDate);
                                const currentCount = parseInt(value);
                                dates[currentDate] = dates[currentDate] || 0;
                                confirmedYValues[dateIndex] = confirmedYValues[dateIndex] || 0;
                                dates[currentDate] += currentCount;
                                confirmedYValues[dateIndex] += currentCount;
                                dateIndex++;
                            }
                        }
                    }
                    {
                        for (const currentLocation of this.deaths) {
                            const currentCountry = currentLocation['Country/Region'];
                            if (!this.checkedCountries.includes(currentCountry)) {
                                continue;
                            }
                            let dateIndex = 0;
                            for (const [key, value] of Object.entries(currentLocation)) {
                                if (['Province/State', 'Country/Region', 'Lat', 'Long'].includes(key)) {
                                    continue;
                                }
                                const currentCount = parseInt(value);
                                deadYValues[dateIndex] = deadYValues[dateIndex] || 0;
                                deadYValues[dateIndex] += currentCount;
                                dateIndex++;
                            }
                        }
                    }

                    chartConfig.data.labels = Array.from(dateLabels);

                    if (this.showCases) {
                        chartConfig.data.datasets[0].data = confirmedYValues;
                    } else {
                        chartConfig.data.datasets[0].data = [];
                    }

                    if (this.showDeaths) {
                        chartConfig.data.datasets[1].data = deadYValues;
                    } else {
                        chartConfig.data.datasets[1].data = [];
                    }

                    graph.update();

                    return confirmedYValues;
                }
            }
        })

    })();


</script>
</body>
</html>
