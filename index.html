<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Coronavirus/COVID-19 Cases</title>
    <script src="bower_components/axios/dist/axios.min.js"></script>
    <script src="bower_components/csvtojson/browser/csvtojson.min.js"></script>
    <script src="bower_components/vue/dist/vue.min.js"></script>
    <script src="bower_components/chart.js/dist/Chart.bundle.min.js"></script>
    <script src="bower_components/regression-js/dist/regression.min.js"></script>
</head>
<body>
<div style="float: right;">
    <canvas id="graph_canvas" width="640" height="480"></canvas>
</div>
<div id="app">
    <div style="float: right;">
        <input id="cases_checkbox" type="checkbox" v-model="showCases"/>
        <label for="cases_checkbox">Cases</label>
        <input id="deaths_checkbox" type="checkbox" v-model="showDeaths"/>
        <label for="deaths_checkbox">Deaths</label>
        <br/>
        <input type="radio" id="joint_axis_radio" name="axes" v-model="axes" value="joint"/>
        <label for="joint_axis_radio">Joint Axis</label>
        <input type="radio" id="separate_axes_radio" name="axes" v-model="axes" value="separate"
               :disabled="!canSeparateAxes"/>
        <label for="separate_axes_radio">Separate Axes</label>
        <br/>
        <input type="radio" id="total_radio" name="derivative" v-model="derivative" v-bind:value="false"/>
        <label for="total_radio">Total</label>
        <input type="radio" id="delta_radio" name="derivative" v-model="derivative" v-bind:value="true"/>
        <label for="delta_radio">Delta</label>
        <br/>
        <select id="regression" v-model="regression">
            <option v-bind:value="null">Choose Regression Model</option>
            <option value="exponential">Exponential</option>
            <option value="logistic" disabled>Logistic</option>
        </select>

    </div>
    <input id="cruise_ship" type="checkbox" v-model="includeCruiseShip"/>
    <label for="cruise_ship" style="font-style: italic;">Cruise Ship (Modifier for Others)</label>
    <br/>
    <input id="cruise_ship_descendants" type="checkbox" v-model="includeCruiseShipDescendants"/>
    <label for="cruise_ship_descendants" style="font-style: italic;">Abroad from Cruise Ship (Modifier)</label>
    <br/>
    <input id="select_all_checkbox" type="checkbox" v-model="selectAll" :indeterminate.prop="partialSelection"/>
    <label for="select_all_checkbox" style="font-weight: bold;">Select All Countries</label>
    <br/>
    <span v-for="country in countries">
        <input type="checkbox" v-bind:id="country" v-bind:value="country" v-model="checkedCountries"/>
        <label v-bind:for="country">{{country}}</label>
        <br/>
    </span>
    <span>Checked countries ({{selectionLength}}): {{checkedCountries}}</span>
    <p>{{timeSeries}}</p>
    <span style="clear: both;"></span>
</div>
<script type="application/javascript">

    function calculateDerivative(values) {
        const derivative = [];
        let previousValue = 0;
        for (const currentValue of values) {
            derivative.push(currentValue - previousValue);
            previousValue = currentValue;
        }
        return derivative;
    }

    (async () => {
        const confirmedResponse = await axios({
            method: 'get',
            url: 'docs/data/covid_confirmed.csv',
        });
        const deadResponse = await axios({
            method: 'get',
            url: 'docs/data/covid_dead.csv',
        });
        const confirmedCases = await csv({output: 'json'}).fromString(confirmedResponse.data);
        const deadCases = await csv({output: 'json'}).fromString(deadResponse.data);

        const dateLabels = new Set();
        for (const key of Object.keys(confirmedCases[0])) {
            if (['Province/State', 'Country/Region', 'Lat', 'Long'].includes(key)) {
                continue;
            }
            dateLabels.add(key);
        }

        // parse the data into what we need
        const countries = new Set();
        const states = new Set();
        const countriesByState = {}; // look up a state's country
        const countryStates = {}; // enumerate up all states in a country
        for (const location of confirmedCases) {
            const currentCountry = location['Country/Region'];
            const currentState = location['Province/State'];
            countries.add(currentCountry);
            if (currentState.length < 1) {
                continue;
            }
            states.add(currentState);
            countriesByState[currentState] = currentCountry;
            countryStates[currentCountry] = countryStates[currentCountry] || new Set();
            countryStates[currentCountry].add(currentState);
        }

        const ticks = {
            beginAtZero: true,
            callback: function (value) {
                return Number(value).toLocaleString();
            }
        };

        const doubleAxes = [
            {
                id: 'cases-axis',
                ticks,
                scaleLabel: {
                    display: true,
                    labelString: 'Cases'
                },
                labelString: 'Cases',
                color: 'orange'
            },
            {
                id: 'deaths-axis',
                ticks,
                position: 'right',
                scaleLabel: {
                    display: true,
                    labelString: 'Deaths'
                },
                color: 'red'
            }
        ];
        const singleAxis = [{ticks}];


        // initialize data set context
        const ctx = document.getElementById('graph_canvas').getContext('2d');
        const chartConfig = {
            type: 'line',
            data: {
                labels: Array.from(dateLabels),
                datasets: [
                    {
                        label: 'Case Count',
                        data: [],
                        backgroundColor: 'rgb(0, 0, 0)',
                        borderColor: 'rgba(240, 200, 50, 1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    },
                    {
                        label: 'Deaths',
                        data: [],
                        backgroundColor: 'rgb(0, 0, 0)',
                        borderColor: 'rgba(220, 50, 50, 1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    },
                    {
                        label: 'Case Regression',
                        data: [],
                        backgroundColor: 'rgb(0, 0, 0)',
                        borderColor: 'rgba(50, 50, 150, 1)',
                        fill: false,
                        cubicInterpolationMode: 'monotone',
                    },
                ],
            },
            options: {
                scales: {
                    yAxes: singleAxis
                },
                tooltips: {
                    // mode: 'x',
                    mode: 'index',
                    intersect: false,
                    callbacks: {
                        label: function (tooltipItem, data) {
                            const value = tooltipItem.value;
                            const label = data.datasets[tooltipItem.datasetIndex].label;
                            return `${label}: ${Number(value).toLocaleString()}`;
                        }
                    }
                }
            }
        };
        const graph = new Chart(ctx, chartConfig);


        const app = new Vue({
            el: '#app',
            data: {
                message: 'Hello Vue!',
                countries,
                cases: confirmedCases,
                deaths: deadCases,
                checkedCountries: [],
                selectAll: false,
                partialSelection: false,
                showCases: true,
                showDeaths: true,
                axes: 'joint',
                derivative: false,
                includeCruiseShip: false,
                includeCruiseShipDescendants: false,
                regression: null
            },
            watch: {
                selectAll: function (newValue) {
                    if (newValue) {
                        this.checkedCountries = Array.from(this.countries);
                        this.partialSelection = false;
                    } else {
                        this.checkedCountries = [];
                    }
                },
                checkedCountries: function (newValue) {
                    const selectedCountryCount = newValue.length;
                    const totalCountryCount = this.countries.size;
                    if (selectedCountryCount === 0) {
                        this.selectAll = false;
                        this.partialSelection = false;
                    } else if (selectedCountryCount === totalCountryCount) {
                        this.selectAll = true;
                        this.partialSelection = false;
                    } else {
                        this.partialSelection = true;
                    }
                },
                axes: function (newValue) {
                    if (newValue === 'joint') {
                        // remove second y axis
                        chartConfig.options.scales.yAxes = singleAxis;
                        delete chartConfig.data.datasets[0].yAxisID;
                        delete chartConfig.data.datasets[1].yAxisID;
                        delete chartConfig.data.datasets[2].yAxisID;
                    } else {
                        chartConfig.options.scales.yAxes = doubleAxes;
                        chartConfig.data.datasets[0].yAxisID = doubleAxes[0].id;
                        chartConfig.data.datasets[2].yAxisID = doubleAxes[0].id;
                        chartConfig.data.datasets[1].yAxisID = doubleAxes[1].id;
                    }
                    graph.update();
                },
                canSeparateAxes: function (newValue) {
                    if (!newValue) {
                        this.axes = 'joint';
                    }
                }
            },
            computed: {
                selectionLength: function () {
                    return this.checkedCountries.length;
                },
                canSeparateAxes: function () {
                    return this.showCases && this.showDeaths;
                },
                timeSeries: function () {
                    const dates = {};
                    let confirmedYValues = [];
                    let deadYValues = [];
                    {
                        for (const currentLocation of this.cases) {
                            const currentCountry = currentLocation['Country/Region'];
                            const currentState = currentLocation['Province/State'];
                            if (!this.checkedCountries.includes(currentCountry)) {
                                continue;
                            }
                            if (!this.includeCruiseShip && currentState === 'Diamond Princess cruise ship') {
                                continue;
                            }
                            if (!this.includeCruiseShipDescendants && currentState.includes('From Diamond Princess')) {
                                continue;
                            }
                            let dateIndex = 0;
                            for (const [key, value] of Object.entries(currentLocation)) {
                                if (['Province/State', 'Country/Region', 'Lat', 'Long'].includes(key)) {
                                    continue;
                                }
                                const currentDate = key;
                                const currentCount = parseInt(value);
                                dates[currentDate] = dates[currentDate] || 0;
                                confirmedYValues[dateIndex] = confirmedYValues[dateIndex] || 0;
                                dates[currentDate] += currentCount;
                                confirmedYValues[dateIndex] += currentCount;
                                dateIndex++;
                            }
                        }
                    }
                    {
                        for (const currentLocation of this.deaths) {
                            const currentCountry = currentLocation['Country/Region'];
                            const currentState = currentLocation['Province/State'];
                            if (!this.checkedCountries.includes(currentCountry)) {
                                continue;
                            }
                            if (!this.includeCruiseShip && currentState === 'Diamond Princess cruise ship') {
                                continue;
                            }
                            if (!this.includeCruiseShipDescendants && currentState.includes('From Diamond Princess')) {
                                continue;
                            }
                            let dateIndex = 0;
                            for (const [key, value] of Object.entries(currentLocation)) {
                                if (['Province/State', 'Country/Region', 'Lat', 'Long'].includes(key)) {
                                    continue;
                                }
                                const currentCount = parseInt(value);
                                deadYValues[dateIndex] = deadYValues[dateIndex] || 0;
                                deadYValues[dateIndex] += currentCount;
                                dateIndex++;
                            }
                        }
                    }

                    if (this.derivative) {
                        confirmedYValues = calculateDerivative(confirmedYValues);
                        deadYValues = calculateDerivative(deadYValues);
                    }

                    if (this.showCases) {
                        chartConfig.data.datasets[0].data = confirmedYValues;
                    } else {
                        chartConfig.data.datasets[0].data = [];
                    }

                    if (this.showDeaths) {
                        chartConfig.data.datasets[1].data = deadYValues;
                    } else {
                        chartConfig.data.datasets[1].data = [];
                    }

                    chartConfig.data.labels = Array.from(dateLabels);
                    chartConfig.data.datasets[2].data = [];
                    if (this.regression === 'exponential') {
                        const regressionDateLabels = Array.from(dateLabels);
                        const regressionRange = [];
                        const extrapolationSize = 5;
                        for (let x = 0; x < confirmedYValues.length + extrapolationSize; x++) {
                            regressionRange.push(x);
                        }
                        for (let x = 1; x <= extrapolationSize; x++) {
                            regressionDateLabels.push(`+${x}`);
                        }
                        chartConfig.data.labels = regressionDateLabels;

                        console.dir(regressionRange);

                        const regressionData = confirmedYValues.map((value, index) => [index, value]);
                        const regressionParams = regression.exponential(regressionData);
                        const extrapolationValues = regressionRange.map(regressionParams.predict);
                        console.dir(regressionData);
                        console.dir(regressionParams);
                        const extrapolationY = extrapolationValues.map(([index, value]) => value);
                        chartConfig.data.datasets[2].data = extrapolationY;
                        console.dir(extrapolationY);
                    }

                    graph.update();

                    return [confirmedYValues, deadYValues];
                }
            }
        })

    })();


</script>
</body>
</html>
